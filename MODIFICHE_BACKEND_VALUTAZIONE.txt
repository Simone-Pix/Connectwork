================================================================================
  MODIFICHE BACKEND IMPLEMENTATE - VALUTAZIONE RICHIESTE
================================================================================
Data: 25 Novembre 2025

================================================================================
ðŸ“‹ FILE MODIFICATI
================================================================================

1. backend/src/main/resources/schema.sql
   âœ… Aggiunta campi alla tabella richieste:
      - cap VARCHAR(10)
      - citta VARCHAR(100)
      - provincia VARCHAR(50)
      - tipo_immobile VARCHAR(50)
      - anno_costruzione SMALLINT
      - stato_conservazione VARCHAR(50)
      - classe_energetica VARCHAR(2)

2. backend/src/main/java/com/immobiliaris/backend/model/Richieste.java
   âœ… Aggiunti 7 nuovi attributi con @Column
   âœ… Aggiunti getter e setter per tutti i nuovi campi

3. backend/src/main/java/com/immobiliaris/backend/controller/RichiesteController.java
   âœ… Aggiunto import ZonePrezziRepository
   âœ… Aggiunto import RichiesteConversioneService
   âœ… Aggiunto import ValutazioneRichiestaDTO
   âœ… NUOVO ENDPOINT: POST /api/richieste/{id}/valuta-automatica
      - Verifica CAP obbligatorio
      - Lookup zona prezzi
      - Calcola valutazione con modificatori
      - Restituisce ValutazioneRichiestaDTO
   âœ… NUOVO ENDPOINT: POST /api/richieste/{id}/converti-immobile
      - Converte richiesta in immobile
      - Crea/trova utente
      - Genera valutazione automatica
      - Elimina richiesta originale
   âœ… Metodi privati helper:
      - calcolaValutazione()
      - calcolaModificatore()
      - generaNote()

================================================================================
ðŸ“„ FILE CREATI
================================================================================

1. backend/src/main/java/com/immobiliaris/backend/dto/ValutazioneRichiestaDTO.java
   âœ… DTO per risposta valutazione
   âœ… Campi: valoreStimatoMin, valoreStimatoMax, prezzoMq, note, zonaNome, cap

2. backend/src/main/java/com/immobiliaris/backend/service/RichiesteConversioneService.java
   âœ… Service per conversione richieste â†’ immobili
   âœ… Metodo convertiRichiestaInImmobile(Long richiestaId)
   âœ… Metodo trovaOCreaUtente() - crea user se non esiste
   âœ… Metodo creaImmobileDaRichiesta() - mapping campi
   âœ… Metodo generaPasswordTemporanea() - sicurezza 12 char

================================================================================
ðŸ”’ SICUREZZA
================================================================================

âœ… SecurityConfig.java GIÃ€ CONFIGURATO:
   - POST /api/richieste/** â†’ PUBBLICO (form utenti)
   - GET /api/richieste/** â†’ PUBBLICO (visualizzazione)
   - PUT /api/richieste/** â†’ AUTENTICATO (solo admin)
   - DELETE /api/richieste/** â†’ AUTENTICATO (solo admin)

NOTA: I nuovi endpoint POST /valuta-automatica e /converti-immobile 
      ereditano la configurazione e sono PUBBLICI per POST.
      Se vuoi renderli privati (solo admin), aggiungi in SecurityConfig:
      
      .requestMatchers(HttpMethod.POST, "/api/richieste/*/valuta-automatica").authenticated()
      .requestMatchers(HttpMethod.POST, "/api/richieste/*/converti-immobile").authenticated()

================================================================================
ðŸ§ª TEST DI COMPILAZIONE
================================================================================

COMANDO: ./mvnw clean compile
RISULTATO: âœ… BUILD SUCCESS
TEMPO: 4.488 secondi
FILE COMPILATI: 48 source files

Nessun errore di compilazione!

================================================================================
ðŸ”„ ENDPOINT DISPONIBILI
================================================================================

VALUTAZIONE AUTOMATICA:
POST /api/richieste/{id}/valuta-automatica
Body: nessuno (usa dati giÃ  salvati nella richiesta)
Response: {
  "valoreStimatoMin": 305370.00,
  "valoreStimatoMax": 333630.00,
  "prezzoMq": 3780.00,
  "note": "Valutazione automatica generata...",
  "zonaNome": "Centro",
  "cap": "10121"
}
Errori possibili:
  - 404 NOT_FOUND: richiesta non esiste
  - 400 BAD_REQUEST: CAP mancante
  - 404 NOT_FOUND: CAP non mappato nel sistema

CONVERSIONE IMMOBILE:
POST /api/richieste/{id}/converti-immobile
Body: nessuno
Response: Immobili object (JSON completo)
Effetti:
  - Crea/trova Users per email
  - Crea nuovo Immobili con stato="bozza"
  - Genera Valutazioni automatica
  - ELIMINA Richieste originale
Errori possibili:
  - 404 NOT_FOUND: richiesta non esiste
  - 400 BAD_REQUEST: CAP mancante

================================================================================
ðŸ“Š ALGORITMO VALUTAZIONE
================================================================================

FORMULA BASE:
prezzoFinale = prezzoBaseZona Ã— modificatoreTotale
valoreTotale = prezzoFinale Ã— superficie
valoreMin/Max = valoreTotale Â± 5%

MODIFICATORI APPLICATI:

1. Stato Conservazione:
   - da_ristrutturare: Ã—0.85 (-15%)
   - buono: Ã—1.00 (base)
   - ottimo: Ã—1.10 (+10%)
   - lusso: Ã—1.25 (+25%)

2. Classe Energetica:
   - A: Ã—1.10 (+10%)
   - B: Ã—1.05 (+5%)
   - C: Ã—1.00 (base)
   - D: Ã—0.95 (-5%)
   - E: Ã—0.90 (-10%)
   - F: Ã—0.85 (-15%)
   - G: Ã—0.80 (-20%)

3. Anno Costruzione:
   - prima 1950: Ã—0.90 (-10%)
   - 1950-1980: Ã—0.95 (-5%)
   - 1981-2000: Ã—1.00 (base)
   - 2001-2010: Ã—1.05 (+5%)
   - dopo 2010: Ã—1.10 (+10%)

4. Piano:
   - <0 (interrato): Ã—0.90 (-10%)
   - 0 (terra): Ã—1.00 (base)
   - 1-3: Ã—1.05 (+5%)
   - 4-6: Ã—1.00 (base)
   - â‰¥7: Ã—0.95 (-5%)

MODIFICATORE FINALE = prod(tutti i modificatori)

================================================================================
ðŸ”„ FLUSSO CONVERSIONE RICHIESTA â†’ IMMOBILE
================================================================================

1. Verifica richiesta esista
2. Verifica CAP presente (OBBLIGATORIO)
3. Cerca utente per email
   - SE ESISTE: usa quello
   - SE NON ESISTE: crea nuovo Users con:
     * nome, cognome, email, telefono dalla richiesta
     * password temporanea casuale (12 char)
     * ruolo = "utente"
     * verificato = false
4. Crea Immobili mappando campi:
   - richieste.stanze â†’ immobili.numLocali
   - richieste.bagni â†’ immobili.numBagni
   - richieste.optionalInfo â†’ immobili.descrizione
   - tutti gli altri campi 1:1
   - stato = "bozza"
5. Salva Immobili
6. Genera Valutazioni automatica (riusa ValutazioniServiceImpl)
7. ELIMINA Richieste (giÃ  processata)
8. Restituisce Immobili creato

================================================================================
âš ï¸ NOTE IMPORTANTI
================================================================================

1. CAMPI OPZIONALI: Tutti i nuovi campi (cap, cittÃ , anno, ecc.) sono NULLABLE
   - La richiesta puÃ² essere salvata anche senza questi campi
   - La valutazione RICHIEDE almeno il CAP
   - Gli altri campi rendono la valutazione piÃ¹ precisa

2. BACKWARD COMPATIBILITY: Richieste esistenti (senza nuovi campi) continuano
   a funzionare normalmente. Solo non potranno essere valutate automaticamente.

3. PASSWORD TEMPORANEE: Quando si crea un nuovo utente, viene generata una 
   password casuale. L'utente dovrÃ  fare reset password al primo accesso.

4. TRANSAZIONI: La conversione Ã¨ @Transactional - se fallisce qualsiasi step,
   viene fatto rollback completo (no dati parziali).

5. VALUTAZIONE OPZIONALE: Se la valutazione fallisce durante la conversione,
   viene loggato l'errore ma la conversione prosegue (immobile creato comunque).

================================================================================
ðŸš€ PROSSIMI PASSI
================================================================================

BACKEND: âœ… COMPLETATO

FRONTEND DA IMPLEMENTARE:
1. Estendere Configurator.jsx con nuovi campi
2. Creare ComponentStep2bis.jsx per CAP, cittÃ , anno, stato, classe
3. Modificare Backoffice.jsx per mostrare pulsanti [Valuta] e [Converti]
4. Creare ModalValutazione.jsx per visualizzare risultati
5. Aggiungere validazione CAP real-time (fetch /api/zone-prezzi/cap/{cap})

DATABASE:
1. Riavviare applicazione per applicare schema.sql modificato
2. OPZIONALE: Popolare dati di test con nuovi campi

TESTING:
1. Testare POST /api/richieste con nuovi campi
2. Testare valutazione automatica
3. Testare conversione immobile

================================================================================
Fine documento
================================================================================
